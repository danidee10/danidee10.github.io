<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Flask by example 5 (Building a simple REST API)</title>
    <meta name="description" content="Osaetin Daniel's blog">
    <link rel="alternate" type="application/atom+xml" title="Osaetin Daniel" href="/feed.xml" />

    <style>
    /*!
 * end2end - jekyll theme free
 * https://github.com/nandomoreirame/end2end
 * MIT License
 */@import url("//fonts.googleapis.com/css?family=Open+Sans:400,300,700");html{box-sizing:border-box}*,*::after,*::before{box-sizing:inherit}html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,hgroup,menu,nav,output,ruby,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline}article,aside,details,figcaption,figure,footer,header,hgroup,menu,nav,section{display:block}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}table{border-collapse:collapse;border-spacing:0}.btn,.sliding-panel-button{appearance:none;background-color:#337ab7;border:0;border-radius:3px;color:#fff;cursor:pointer;display:inline-block;font-family:"Open Sans","Helvetica Neue","Helvetica","Roboto","Arial",sans-serif;font-size:1em;-webkit-font-smoothing:antialiased;font-weight:600;line-height:1;padding:.75em 1.5em;text-decoration:none;transition:background-color .2s ease;user-select:none;vertical-align:middle;white-space:nowrap}.btn:hover,.sliding-panel-button:hover,.btn:focus,.sliding-panel-button:focus{background-color:#296292;color:#fff}.btn:disabled,.sliding-panel-button:disabled{cursor:not-allowed;opacity:0.5}.btn:disabled:hover,.sliding-panel-button:disabled:hover{background-color:#337ab7}fieldset{background-color:#f7f7f7;border:1px solid #dedede;margin:0 0 .75em;padding:1.5em}input,label,select{display:block;font-family:"Open Sans","Helvetica Neue","Helvetica","Roboto","Arial",sans-serif;font-size:1em}label{font-weight:600;margin-bottom:.375em}label.required::after{content:"*"}label abbr{display:none}input[type="color"],input[type="date"],input[type="datetime"],input[type="datetime-local"],input[type="email"],input[type="month"],input[type="number"],input[type="password"],input[type="search"],input[type="tel"],input[type="text"],input[type="time"],input[type="url"],input[type="week"],input:not([type]),textarea,select[multiple=multiple]{background-color:#fff;border:1px solid #dedede;border-radius:3px;box-shadow:inset 0 1px 3px rgba(0,0,0,0.06);box-sizing:border-box;font-family:"Open Sans","Helvetica Neue","Helvetica","Roboto","Arial",sans-serif;font-size:1em;margin-bottom:.75em;padding:.5em;transition:border-color .2s ease;width:100%}input[type="color"]:hover,input[type="date"]:hover,input[type="datetime"]:hover,input[type="datetime-local"]:hover,input[type="email"]:hover,input[type="month"]:hover,input[type="number"]:hover,input[type="password"]:hover,input[type="search"]:hover,input[type="tel"]:hover,input[type="text"]:hover,input[type="time"]:hover,input[type="url"]:hover,input[type="week"]:hover,input:not([type]):hover,textarea:hover,select[multiple=multiple]:hover{border-color:#b2b2b2}input[type="color"]:focus,input[type="date"]:focus,input[type="datetime"]:focus,input[type="datetime-local"]:focus,input[type="email"]:focus,input[type="month"]:focus,input[type="number"]:focus,input[type="password"]:focus,input[type="search"]:focus,input[type="tel"]:focus,input[type="text"]:focus,input[type="time"]:focus,input[type="url"]:focus,input[type="week"]:focus,input:not([type]):focus,textarea:focus,select[multiple=multiple]:focus{border-color:#337ab7;box-shadow:inset 0 1px 3px rgba(0,0,0,0.06),0 0 5px rgba(45,109,163,0.7);outline:none}input[type="color"]:disabled,input[type="date"]:disabled,input[type="datetime"]:disabled,input[type="datetime-local"]:disabled,input[type="email"]:disabled,input[type="month"]:disabled,input[type="number"]:disabled,input[type="password"]:disabled,input[type="search"]:disabled,input[type="tel"]:disabled,input[type="text"]:disabled,input[type="time"]:disabled,input[type="url"]:disabled,input[type="week"]:disabled,input:not([type]):disabled,textarea:disabled,select[multiple=multiple]:disabled{background-color:#f2f2f2;cursor:not-allowed}input[type="color"]:disabled:hover,input[type="date"]:disabled:hover,input[type="datetime"]:disabled:hover,input[type="datetime-local"]:disabled:hover,input[type="email"]:disabled:hover,input[type="month"]:disabled:hover,input[type="number"]:disabled:hover,input[type="password"]:disabled:hover,input[type="search"]:disabled:hover,input[type="tel"]:disabled:hover,input[type="text"]:disabled:hover,input[type="time"]:disabled:hover,input[type="url"]:disabled:hover,input[type="week"]:disabled:hover,input:not([type]):disabled:hover,textarea:disabled:hover,select[multiple=multiple]:disabled:hover{border:1px solid #dedede}textarea{resize:vertical}input[type="search"]{appearance:none}input[type="checkbox"],input[type="radio"]{display:inline;margin-right:.375em}input[type="checkbox"]+label,input[type="radio"]+label{display:inline-block}input[type="file"]{margin-bottom:.75em;width:100%}select{margin-bottom:1.5em;max-width:100%;width:auto}ul,ol{margin:0;padding:0;list-style-position:inside;padding-left:25px}dl{margin-bottom:.75em}dl dt{font-weight:bold;margin-top:.75em}dl dd{margin:0}table{border-collapse:collapse;font-feature-settings:"kern", "liga", "tnum";margin:.75em 0;table-layout:fixed;width:100%}th{border-bottom:1px solid #a7a7a7;font-weight:600;padding:.75em 0;text-align:left}td{border-bottom:1px solid #dedede;padding:.75em 0}tr,td,th{vertical-align:middle}body{color:#000000;font-size:18px;font-weight:400;line-height:1.5}h1,h2,h3,h4,h5,h6{font-family:"Open Sans","Helvetica Neue","Helvetica","Roboto","Arial",sans-serif;font-size:1em;line-height:1.2;font-weight:700;margin:0 0 .75em}h1{font-size:35px; color: #337ab7;}h2{font-size:1.625rem}h3{font-size:1.5rem}h4{font-size:1.25rem}h5,h6{font-size:1rem}p{margin:0 0 .75em;font-weight:300}em{font-style:italic}small{font-size:80%}a{color:#337ab7;text-decoration:none;-webkit-transition:color .2s ease;-moz-transition:color .2s ease;transition:color .2s ease}a:active,a:focus,a:hover{color:#265c89}hr{border-bottom:1px solid #dedede;border-left:0;border-right:0;border-top:0;margin:1.5em 0}img,picture{margin:0;max-width:100%}code{background:none;border-radius:0;border:none;font-family:"Courier New", monospace;font-size:0.9em;margin:0;padding:0 5px;background-color:#ededed}pre{-webkit-overflow-scrolling:touch;font-family:"Courier New", monospace;font-size:0.9em;margin:0}pre code{line-height:1.75em}.txt-primary{color:#337ab7}.txt-white{color:#fff}.txt-black{color:#000}.txt-blue{color:#477dca}.txt-dark-gray{color:#232323}.txt-medium-gray{color:#9a9a9a}.txt-light-gray{color:#dedede}.txt-left{text-align:left}.txt-right{text-align:right}.txt-center{text-align:center}.txt-justify{text-align:justify}.word-wrap{overflow-wrap:break-word;word-wrap:break-word;word-break:break-all}.dot{border-radius:50%}blockquote{background:#f9f9f9;border-left:10px solid #ccc;margin:1.5em 10px;padding:0.5em 10px;quotes:"“" "”" "‘" "’"}blockquote:before{color:#ccc;content:open-quote;font-size:4em;line-height:0.1em;margin-right:0.25em;vertical-align:-0.4em}blockquote p{display:inline}.site-header::after,.social::after,.pagination::after,.highlight::after{clear:both;content:"";display:table}html,body{min-height:100%;height:100%}body{border-top:5px solid #337ab7;background:#fff url("/images/bg-pattern.png")}.container{max-width:800px;margin-left:auto;margin-right:auto;padding-left:.75em;padding-right:.75em}.container::after{clear:both;content:"";display:table}.card,.post-list .post{background-color:#fff;box-shadow:0 2px 1px rgba(0,0,0,0.1);margin:0 0 1.5em;padding:1.5em .75em}@media screen and (min-width: 480px){.card,.post-list .post{padding:1.5em}}.site-header{background-color:#fff;padding:1.5em 0;margin-bottom:1.5em;border-bottom:1px solid rgba(222,222,222,0.5)}.site-header h1{margin:0;padding:5px 0;float:left;font-weight:400;font-size:1.25rem}.site-header h1 span{color:#337ab7}.site-header h1,.site-header a{text-transform:lowercase}.site-header .navbar{float:right}.site-header a{color:#9a9a9a}.site-header a:hover,.site-header a:focus,.site-header a:active{color:#232323}@media screen and (max-width: 480px){.site-header .container{padding-left:1.5em;padding-right:1.5em}}.sliding-panel-button{float:right;padding:5px;margin:0 3.75em 0 0}.sliding-panel-button span{width:30px;display:block;height:3px;border-radius:2px;background:#fff;margin:3px 0}@media screen and (min-width: 480px){.sliding-panel-button{display:none}}@media screen and (max-width: 480px){.sliding-panel-content{border-top:5px solid #337ab7;position:fixed;top:0;right:auto;bottom:0;left:0;height:100%;width:220px;-webkit-transform:translateX(-100%);-moz-transform:translateX(-100%);-ms-transform:translateX(-100%);-o-transform:translateX(-100%);transform:translateX(-100%);-webkit-transition:all 0.25s linear;-moz-transition:all 0.25s linear;transition:all 0.25s linear;background:#fff;-webkit-overflow-scrolling:touch;overflow-y:auto;z-index:999999}.sliding-panel-content.is-visible{-webkit-transform:translateX(0);-moz-transform:translateX(0);-ms-transform:translateX(0);-o-transform:translateX(0);transform:translateX(0)}.sliding-panel-fade-screen{position:fixed;top:0;right:0;bottom:0;left:0;-webkit-transition:all 0.15s ease-out 0s;-moz-transition:all 0.15s ease-out 0s;transition:all 0.15s ease-out 0s;background:#000;opacity:0;visibility:hidden;z-index:9999}.sliding-panel-fade-screen.is-visible{opacity:0.4;visibility:visible}.sliding-panel-close{cursor:pointer}}.navbar li,.navbar a{display:inline-block}.navbar a{padding:5px 15px}@media screen and (max-width: 600px){.navbar a{padding:5px 10px}}@media screen and (max-width: 480px){.navbar li,.navbar a{display:block;text-align:center}.navbar li{border-bottom:1px solid #f2f2f2}.navbar a{padding:15px 0}}.btn.btn-ghost,.btn-ghost.sliding-panel-button{background-color:transparent;border:2px solid #337ab7;color:#337ab7;margin-bottom:2px}.btn.disabled,.disabled.sliding-panel-button,.btn[disabled],[disabled].sliding-panel-button,fieldset[disabled] .btn,fieldset[disabled] .sliding-panel-button{cursor:not-allowed;filter:alpha(opacity=65);-webkit-box-shadow:none;box-shadow:none;opacity:.65}body.home{width:100%;display:table}.hero{text-align:center;display:table-cell;vertical-align:middle}.hero-inner{text-align:center;display:inline-block;padding:1.5em}.hero-inner .dot{padding:5px;border:1px solid #dedede}.hero-inner h1{margin-top:.7em;font-size:2.5rem}.hero-inner h3{font-size:1.25rem;margin:.8em 0 1.2em}@media screen and (min-width: 600px){.hero-inner h3{font-size:1.5rem}}.hero-inner h3,.hero-inner em{font-weight:300}.hero-inner em{color:#337ab7}.hero-inner strong{font-weight:700}.post{padding:1.5em 0}.post-header{margin-bottom:1.5em; padding-bottom: 5px; border-bottom: 1px solid #999;}.post-title{font-size:1.625rem;margin-bottom:0;line-height:1.5em}.post-list .post a{color:#636363}.post-list .post a:hover,.post-list .post a:active,.post-list .post a:focus{color:#337ab7}.social{padding:1.5em 0}.social li{display:inline-block;padding:0 .6em}.social a{color:#9a9a9a}.social a:hover,.social a:active,.social a:focus{color:#337ab7}.social i{font-size:1.2em}.pagination{text-align:center;margin:2em 0}.pagination li{padding:0 .4em}.pagination li,.pagination a,.pagination span{display:inline-block}.pagination a,.pagination span{line-height:1.2em;font-size:.75rem}.pagination .btn,.pagination .sliding-panel-button{color:#636363;border-color:rgba(222,222,222,0.8)}.pagination span{color:#aaa;font-style:italic}.site-footer{background-color:#fff;border-top:1px solid rgba(222,222,222,0.5);padding:1.5em;text-align:center}.site-footer p{margin:0}.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width: 500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}@font-face{font-family:"end2end-icons";src:url("../fonts/end2end-icons.eot?vs69d0");src:url("../fonts/end2end-icons.eot?vs69d0#iefix") format("embedded-opentype"),url("../fonts/end2end-icons.ttf?vs69d0") format("truetype"),url("../fonts/end2end-icons.woff?vs69d0") format("woff"),url("../fonts/end2end-icons.svg?vs69d0#end2end-icons") format("svg");font-weight:normal;font-style:normal}.icon{font-family:"end2end-icons" !important;speak:none;font-style:normal;font-weight:normal;font-variant:normal;text-transform:none;line-height:1;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-home:before{content:""}.icon-comments:before{content:""}.icon-comment-o:before{content:""}.icon-comments-o:before{content:""}.icon-search:before{content:""}.icon-share:before{content:""}.icon-google-plus:before{content:""}.icon-facebook:before{content:""}.icon-facebook-rounded:before{content:""}.icon-twitter:before{content:""}.icon-twitter-rounded:before{content:""}.icon-feed:before{content:""}.icon-github:before{content:""}.icon-linkedin:before{content:""}.highlight{padding:0;margin-top:1.2em;margin-bottom:1.2em}.highlight,.highlight .hll,.highlight pre,.highlight code{background-color:#272822 !important;border:none}.highlight pre{margin:0;padding:1.3em;white-space:pre;line-height:23px;overflow-x:auto;margin-bottom:0;word-break:inherit;word-wrap:inherit}.highlight pre,.highlight pre code{color:#eeffdd}.highlight pre code{white-space:pre;padding:0 !important}.highlight pre code *{white-space:nowrap}.highlight .c{color:#75715e}.highlight .err{color:#f2f1f2}.highlight .k{color:#66d9ef}.highlight .l{color:#ae81ff}.highlight .n{color:#f8f8f2}.highlight .o{color:#f92672}.highlight .p{color:#f8f8f2}.highlight .cm{color:#75715e}.highlight .cp{color:#75715e}.highlight .c1{color:#75715e}.highlight .cs{color:#75715e}.highlight .ge{font-style:italic}.highlight .gs{font-weight:bold}.highlight .kc{color:#66d9ef}.highlight .kd{color:#66d9ef}.highlight .kn{color:#f92672}.highlight .kp{color:#66d9ef}.highlight .kr{color:#66d9ef}.highlight .kt{color:#66d9ef}.highlight .ld{color:#e6db74}.highlight .m{color:#ae81ff}.highlight .s{color:#e6db74}.highlight .na{color:#a6e22e}.highlight .nb{color:#f8f8f2}.highlight .nc{color:#a6e22e}.highlight .no{color:#66d9ef}.highlight .nd{color:#a6e22e}.highlight .ni{color:#f8f8f2}.highlight .ne{color:#a6e22e}.highlight .nf{color:#a6e22e}.highlight .nl{color:#f8f8f2}.highlight .nn{color:#f8f8f2}.highlight .nx{color:#a6e22e}.highlight .py{color:#f8f8f2}.highlight .nt{color:#f92672}.highlight .nv{color:#f8f8f2}.highlight .ow{color:#f92672}.highlight .w{color:#f8f8f2}.highlight .mf{color:#ae81ff}.highlight .mh{color:#ae81ff}.highlight .mi{color:#ae81ff}.highlight .mo{color:#ae81ff}.highlight .sb{color:#e6db74}.highlight .sc{color:#e6db74}.highlight .sd{color:#e6db74}.highlight .s2{color:#e6db74}.highlight .se{color:#ae81ff}.highlight .sh{color:#e6db74}.highlight .si{color:#e6db74}.highlight .sx{color:#e6db74}.highlight .sr{color:#e6db74}.highlight .s1{color:#e6db74}.highlight .ss{color:#e6db74}.highlight .bp{color:#f8f8f2}.highlight .vc{color:#f8f8f2}.highlight .vg{color:#f8f8f2}.highlight .vi{color:#f8f8f2}.highlight .il{color:#ae81ff}.highlight .gu{color:#75715e}.highlight .gd{color:#f92672}.highlight .gi{color:#a6e22e}

body {
  font-family: "Open sans";
  font-weight: 400;
}

.container {
  max-width: 950px;
}

.post-meta {
  font-style: italic;
  font-size: 16px;
}

strong {
  font-weight: bold;
}

a {
  font-weight: bold;
}

.postlist {
  list-style: inside;
  font-style: italic;
}

    </style>

    <script src="https://use.fontawesome.com/5bbf16a3a0.js"></script>

    <link rel="canonical" href="https://danidee10.github.io/2016/10/05/flask-by-example-5.html">

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-83888894-1', 'auto');
      ga('send', 'pageview');

    </script>

  </head>


    <main>
      <header class="site-header">
  <div class="container">
    <h1><a href="/">Osaetin<span>Daniel</span></a></h1>

    <button type="button" class="sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <nav class="navbar sliding-panel-content">
      <ul>

          <li><a href="/about" title="About">About</a></li>

          <li><a href="/blog" title="Blog">Blog</a></li>

        <!--rssfeed li><a href="/end2end/feed.xml" target="_blank"><i class="icon icon-feed"></i></a></li-->
      </ul>
    </nav>
  </div>
</header>


      <div class="sliding-panel-fade-screen"></div>

      <div class="container">
        <article role="article" class="post">
          <div class="card">
            <header class="post-header">
              <h1 class="post-title">Flask by example 5 (Building a simple REST API)</h1>
              <p class="post-meta">October 05, 2016</i>
            </header>

            <div class="post-content">
              <p>Welcome to part 5. In this part I’m going to show you how to build your own RESTful API with flask</p>

<p>That would serve as the middle-man between the browser and the web server and it’s the means by which data would be sent between both parties.</p>

<p>At the end of this tutorial you’d have created an API that receives data as json, parses it and stores the information in the database and also send back json when you query it.</p>

<p>This is an overview on the structure of our application after you complete this part</p>

<p><img src="/images/flask-5-overview.png" alt="flask part 5" /></p>

<h2 id="why-do-we-need-an-api">WHY DO WE NEED AN API</h2>
<p>I’m not going to bore you out with all the numerous reasons to use an API, because you’ve probably read them online somewhere if you’ve not here are <a href="http://sproutsocial.com/insights/what-is-an-api/">some</a>.</p>

<p>The main reason why need an API is because client-side Javascript libraries like ReactJS cannot communicate directly with your database (which resides on the server) directly. Though Server side Javascript like NodeJS can do that.</p>

<p>This is how our form declaration looks with React.</p>

<h4 id="with-react">With React</h4>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">"poll_form"</span> <span class="na">className=</span><span class="s">"form-signin"</span> <span class="na">onSubmit=</span><span class="s">{this.handleSubmit}</span><span class="nt">&gt;</span></code></pre></figure>

<p>without React we have this</p>

<h4 id="without-react">Without React</h4>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">"poll_form"</span> <span class="na">className=</span><span class="s">"form-signin"</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">action=</span><span class="s">"/polls"</span><span class="nt">&gt;</span></code></pre></figure>

<p>When the <code class="highlighter-rouge">handleSubmit</code> function is eventually called a lot of “DOM changing” processes would have gone on in the other methods <code class="highlighter-rouge">handleOptionAdd</code>, <code class="highlighter-rouge">handleOptionChange</code> and <code class="highlighter-rouge">handleTitleChange</code> (Adding options and setting the Title of the poll) that the DOM wouldn’t know about.</p>

<p>I urge you to experiment and  submit the form without using the <code class="highlighter-rouge">onSubmit</code> handler (the example i gave without react) and see what happens when you print <code class="highlighter-rouge">request.form</code> in flask.</p>

<p>So in summary an API serves as a common interface for the client and the server to talk to each other reliably. Enough of the talk let’s build an API.</p>

<p><em>The full code of some of some files won’t be pasted, Only the important part will be pasted so if you want to see the full source code at any point, feel free to checkout the github <a href="https://github.com/danidee10/Votr">repo</a></em></p>

<h2 id="building-the-api">Building the API</h2>

<p>Our API is going to perform two basic functions at this stage:
  1. Receive data as a valid JSON string, parse it and store the information in the database
  2. Return data in the form of JSON back to our client who then decides on what he wants to do with the data. We’re simply providing the raw data back and not forcing the presentation of the data on the client</p>

<p>This is how the JSON would be structured. Let’s call this our dream API</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
	<span class="s2">"Polls"</span><span class="err">:</span> <span class="p">[{</span>
			<span class="s2">"title"</span><span class="p">:</span> <span class="s2">"poll1"</span><span class="p">,</span>
			<span class="s2">"options"</span><span class="p">:</span> <span class="p">[{</span>
				<span class="s2">"name"</span><span class="p">:</span> <span class="s2">"option1"</span><span class="p">,</span>
				<span class="s2">"vote_count"</span><span class="p">:</span> <span class="s2">"45"</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="s2">"name"</span><span class="p">:</span> <span class="s2">"option2"</span><span class="p">,</span>
				<span class="s2">"vote_count"</span><span class="p">:</span> <span class="s2">"16"</span>

			<span class="p">}],</span>
			<span class="s2">"status"</span><span class="p">:</span> <span class="s2">"open"</span>

		<span class="p">},</span>

		<span class="p">{</span>
			<span class="s2">"title"</span><span class="p">:</span> <span class="s2">"poll2"</span><span class="p">,</span>
			<span class="s2">"options"</span><span class="p">:</span> <span class="p">[{</span>
				<span class="s2">"name"</span><span class="p">:</span> <span class="s2">"option2"</span><span class="p">,</span>
				<span class="s2">"vote_count"</span><span class="p">:</span> <span class="s2">"12"</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="s2">"name"</span><span class="p">:</span> <span class="s2">"option2"</span><span class="p">,</span>
				<span class="s2">"vote_count"</span><span class="p">:</span> <span class="s2">"18"</span>

			<span class="p">}],</span>
			<span class="s2">"status"</span><span class="p">:</span> <span class="s2">"closed"</span>
		<span class="p">}</span>
	<span class="p">]</span>
<span class="p">}</span></code></pre></figure>

<p>If the JSON looks scary to you, just think of them as python dictionaries and lists and the structure should become clearer. You can also check the validity of this JSON and any JSON string online with <a href="http://jsonlint.com/">JSON lint</a></p>

<p>Moving forward, we’re going to separate our <code class="highlighter-rouge">API</code> calls from our main application routes by prefixing the url with <code class="highlighter-rouge">/api</code></p>

<p><em>hint: We’re goint to refactor the whole codebase at the end of this series and make our API into a flask blueprint. if you don’t know what a blueprint is in flask this might be a good time to <a href="http://flask.pocoo.org/docs/0.11/blueprints/">check it out</a></em></p>

<p>Edit the <code class="highlighter-rouge">votr.py</code> file to include a new route <code class="highlighter-rouge">/api/polls</code></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@votr.route</span><span class="p">(</span><span class="s">'/api/polls'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="c"># retrieves/adds polls from/to the database</span>
<span class="k">def</span> <span class="nf">api_polls</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="c"># get the poll and save it in the database</span>
        <span class="n">poll</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

        <span class="k">return</span> <span class="s">"The title of the poll is {} and the options are {} and {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">poll</span><span class="p">[</span><span class="s">'title'</span><span class="p">],</span> <span class="o">*</span><span class="n">poll</span><span class="p">[</span><span class="s">'options'</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c"># query the db and return all the polls as json</span>
        <span class="n">all_polls</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># get all the topics in the database</span>
        <span class="n">topics</span> <span class="o">=</span> <span class="n">Topics</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="nb">all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="n">topics</span><span class="p">:</span>
            <span class="c"># for each topic get the all polls that are it's children</span>
            <span class="n">all_polls</span><span class="p">[</span><span class="n">topic</span><span class="o">.</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">'options'</span><span class="p">:</span> <span class="p">[</span><span class="n">poll</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">poll</span> <span class="ow">in</span> <span class="n">Polls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="n">topic</span><span class="p">)]}</span>

        <span class="c">#print(jsonify(json_list=Topics.query.join(Polls).all()))</span>
        <span class="k">print</span><span class="p">(</span><span class="n">all_polls</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">all_polls</span><span class="p">)</span></code></pre></figure>

<p>In the POST request, we aren’t really doing anything, we just get the JSON the user sent with <code class="highlighter-rouge">request.get_json()</code> and then return the details back to show us that our API works.</p>

<p>In the GET request, our aim was to return a json string containing the poll and various details associated with it. To acheive that we queried the database for all the existing Topics and then for each topic we fetched the associated polls (<code class="highlighter-rouge">Polls.query.filter_by(topic=topic)</code>), after that we appended the results in the format we wanted and then used a flask function called <code class="highlighter-rouge">jsonify</code> to convert the string to JSON. jsonify is similar to python’s json.dumps but it actually does more for you behind the scenes that pure json.dumps won’t do.</p>

<p>Okay our code works but we could still improve it, by leveraging the power of SQLAlchemy by using an SQL join statement <em>But how do you use a join statement when you’re not writing raw SQL…Simple use SQLAlchemy</em></p>

<h5 id="lets-fire-up-a-terminal-and-play-around">Let’s fire up a terminal and play around</h5>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">&gt;&gt;&gt; </span>from votr import db, votr, Topics, Polls
<span class="gp">&gt;&gt;&gt; </span>db.app <span class="o">=</span> votr
<span class="gp">&gt;&gt;&gt; </span>db.init_app<span class="o">(</span>votr<span class="o">)</span>
<span class="gp">&gt;&gt;&gt; </span>Topics.query.join<span class="o">(</span>Polls<span class="o">)</span>.all<span class="o">()</span>
<span class="o">[</span>Which side is going to win the EPL this season, Whos better liverpool or city]</code></pre></figure>

<p>Neat! we were able to fetch all the topics and their associated polls in a single query. Though you’re seeing only the title of the Topic (that’s <code class="highlighter-rouge">__repr__</code> in action). those two items are actually SQLAlchemy objects that contain all the data you need, you just need to know how to extract them from the object.</p>

<p>Another amazing thing about SQLAlchemy is that we can see the query it generated for us behind the scenes</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="nb">str</span><span class="p">(</span><span class="n">Topics</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Polls</span><span class="p">))</span>     
<span class="s">'SELECT topics.id AS topics_id, topics.date_created AS topics_date_created, topics.date_modified AS topics_date_modified, topics.title AS topics_title </span><span class="se">\n</span><span class="s">FROM topics JOIN polls ON topics.id = polls.topic_id'</span></code></pre></figure>

<p>You can also see the specific query for an SQL dialect</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">sqlalchemy.dialects</span> <span class="kn">import</span> <span class="n">postgresql</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ddd</span> <span class="o">=</span> <span class="n">Topics</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Polls</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">ddd</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">postgresql</span><span class="o">.</span><span class="n">dialect</span><span class="p">()))</span>
<span class="n">SELECT</span> <span class="n">topics</span><span class="o">.</span><span class="nb">id</span><span class="p">,</span> <span class="n">topics</span><span class="o">.</span><span class="n">date_created</span><span class="p">,</span> <span class="n">topics</span><span class="o">.</span><span class="n">date_modified</span><span class="p">,</span> <span class="n">topics</span><span class="o">.</span><span class="n">title</span>
<span class="n">FROM</span> <span class="n">topics</span> <span class="n">JOIN</span> <span class="n">polls</span> <span class="n">ON</span> <span class="n">topics</span><span class="o">.</span><span class="nb">id</span> <span class="o">=</span> <span class="n">polls</span><span class="o">.</span><span class="n">topic_id</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">sqlalchemy.dialects</span> <span class="kn">import</span> <span class="n">sqlite</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">ddd</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">sqlite</span><span class="o">.</span><span class="n">dialect</span><span class="p">()))</span>
<span class="n">SELECT</span> <span class="n">topics</span><span class="o">.</span><span class="nb">id</span><span class="p">,</span> <span class="n">topics</span><span class="o">.</span><span class="n">date_created</span><span class="p">,</span> <span class="n">topics</span><span class="o">.</span><span class="n">date_modified</span><span class="p">,</span> <span class="n">topics</span><span class="o">.</span><span class="n">title</span>
<span class="n">FROM</span> <span class="n">topics</span> <span class="n">JOIN</span> <span class="n">polls</span> <span class="n">ON</span> <span class="n">topics</span><span class="o">.</span><span class="nb">id</span> <span class="o">=</span> <span class="n">polls</span><span class="o">.</span><span class="n">topic_id</span></code></pre></figure>

<p>For the experienced database admins this could be pretty useful, as an ORM doesn’t generate the most efficient SQL query sometimes (but there’s no need for premature optimization at this level). And as a beginner you could also learn more about complex SQL queries that SQLAlchemy allows you to create easily</p>

<p>Okay, so how do we convert this complex query object into a dictionary which can be jsonified.</p>

<p>To do that we’re going to define a method called <code class="highlighter-rouge">to_json</code> in the <code class="highlighter-rouge">Topics</code> Model that abstracts this functionality and simply gives us a custom dictionary representation of the object.</p>

<p>Update the <code class="highlighter-rouge">Topics</code> model and add a <code class="highlighter-rouge">to_json</code> method</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># returns dictionary that can easily be jsonified</span>
<span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
            <span class="s">'title'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="s">'options'</span><span class="p">:</span>
                <span class="p">[{</span><span class="s">'name'</span><span class="p">:</span> <span class="n">option</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">'vote_count'</span><span class="p">:</span> <span class="n">option</span><span class="o">.</span><span class="n">vote_count</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="nb">all</span><span class="p">()]</span>
        <span class="p">}</span></code></pre></figure>

<p>Now we can simply call <code class="highlighter-rouge">to_json</code> on any <code class="highlighter-rouge">Topic</code> to get a custom <code class="highlighter-rouge">dict</code> representation, which leaves us with a simple list comprehension</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">&gt;&gt;&gt; </span><span class="o">[</span>poll.to_json<span class="o">()</span> <span class="k">for </span>poll <span class="k">in </span>polls]
<span class="o">[{</span><span class="s1">'title'</span>: <span class="s1">'Which side is going to win the EPL this season'</span>, <span class="s1">'options'</span>: <span class="o">[{</span><span class="s1">'name'</span>: <span class="s1">'Arsenal'</span>, <span class="s1">'vote_count'</span>: None<span class="o">}</span>, <span class="o">{</span><span class="s1">'name'</span>: <span class="s1">'Spurs'</span>, <span class="s1">'vote_count'</span>: None<span class="o">}]}</span>, <span class="o">{</span><span class="s1">'title'</span>: <span class="s1">'Whos better liverpool or city'</span>, <span class="s1">'options'</span>: <span class="o">[{</span><span class="s1">'name'</span>: <span class="s1">'Liverpool FC'</span>, <span class="s1">'vote_count'</span>: None<span class="o">}</span>, <span class="o">{</span><span class="s1">'name'</span>: <span class="s1">'Manchester city'</span>, <span class="s1">'vote_count'</span>: None<span class="o">}]}]</span>
&gt;&gt;&gt;</code></pre></figure>

<h3 id="wait-what-about-the-poll-state">Wait? what about the poll state</h3>
<p>This is the kind of JSON that our API will send back to us when we query it currently.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
	<span class="s2">"Polls"</span><span class="err">:</span> <span class="p">[{</span>
			<span class="s2">"title"</span><span class="p">:</span> <span class="s2">"poll1"</span><span class="p">,</span>
			<span class="s2">"options"</span><span class="p">:</span> <span class="p">[{</span>
				<span class="s2">"name"</span><span class="p">:</span> <span class="s2">"option1"</span><span class="p">,</span>
				<span class="s2">"vote_count"</span><span class="p">:</span> <span class="s2">"45"</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="s2">"name"</span><span class="p">:</span> <span class="s2">"option2"</span><span class="p">,</span>
				<span class="s2">"vote_count"</span><span class="p">:</span> <span class="s2">"16"</span>

			<span class="p">}]</span>

		<span class="p">},</span>

		<span class="p">{</span>
			<span class="s2">"title"</span><span class="p">:</span> <span class="s2">"poll2"</span><span class="p">,</span>
			<span class="s2">"options"</span><span class="p">:</span> <span class="p">[{</span>
				<span class="s2">"name"</span><span class="p">:</span> <span class="s2">"option2"</span><span class="p">,</span>
				<span class="s2">"vote_count"</span><span class="p">:</span> <span class="s2">"12"</span>
			<span class="p">},</span> <span class="p">{</span>
				<span class="s2">"name"</span><span class="p">:</span> <span class="s2">"option2"</span><span class="p">,</span>
				<span class="s2">"vote_count"</span><span class="p">:</span> <span class="s2">"18"</span>

			<span class="p">}]</span>
		<span class="p">}</span>
	<span class="p">]</span>
<span class="p">}</span></code></pre></figure>

<p>What happened to our dream API, weren’t we supposed to have the status of the poll included.</p>

<p>Yes we were but we can’t, because well…our database design is broken. Yes you read that right it’s broken. The status of the poll is supposed to be a column on the <code class="highlighter-rouge">Topics</code> model, so once we set a Topic as closed all options under it can immediately know that their parent Topic has been closed hence closing the poll.</p>

<p>But you went ahead and put it in the <code class="highlighter-rouge">Polls</code> table (actually i misled you and congrats! you fell for it brilliantly).</p>

<p>So after cursing yourself and me, how do you correct this mistake. Yes you’re interacting with your database with python through SQLAlchemy and you can easily cut and paste the status line into the <code class="highlighter-rouge">Topics</code> model. But that’s not going to work.</p>

<p>SQLAlchemy on it’s own can only alter the schema of our database by adding new models, but we’ve found ourself in a situation where we need to delete a column from a table and then add that column to another table. (altering two tables)</p>

<p>SQLAlchemy and other ORM’s are only an abstraction not a direct replacement, so at the end of the day you’re still working with a database and SQL. SQLAlchemy cannot magically alter and update the database for you it’s just an ORM.</p>

<p>The database also, knows nothing about python so it wouldn’t know when we made any change to the python file containing your models. The models need a way need a way to tell the database <em>hey one of the us just got updated. you need to updated yourself to match our current state</em></p>

<p>This is where <a href="https://flask-migrate.readthedocs.io/en/latest/">Flask-Migrate</a> comes to the rescue and says step aside guys I’ll settle this.</p>

<h3 id="flask-migrate">Flask Migrate</h3>
<p>Quoting the <a href="https://flask-migrate.readthedocs.io/en/latest/">docs</a></p>

<p><em>Flask-Migrate is an extension that handles SQLAlchemy database migrations for Flask applications using <strong>Alembic</strong>. The database operations are made available through the Flask command-line interface or through the Flask-Script extension.</em></p>

<p>So what exactly is a migration?</p>

<p>Migrations (also known as ‘schema evolution’ or ‘mutations’) are simply a way of changing your database schema from one version into another.</p>

<p>Doing database migrations manually is very problematic, sure you could use a tool like PHPMyadmin to edit your table and update it, but picture this scenario - You’ve done a lot of migrations manually with a graphical tool or from the command line and then for some reason, you need to go three steps back to the previous migrations. If you don’t have a good memory or you didn’t document the state of your database then, you’re screwed.</p>

<p>Flask Migrate (and other solutions for other web frameworks) are not meant for updating the schema of your database only. They also form a way of creating your database initially and then if for some reason you want to go back to a previous state. you can simply run an older migration.</p>

<p>So let’s go on and install flask migrate from pip</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">pip install flask_migrate</code></pre></figure>

<p>Edit <code class="highlighter-rouge">votr.py</code> and import the <code class="highlighter-rouge">Migrate</code> class from <code class="highlighter-rouge">flask_migrate</code></p>

<p>This is how <code class="highlighter-rouge">votr.py</code> looks like now</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">werkzeug.security</span> <span class="kn">import</span> <span class="n">generate_password_hash</span><span class="p">,</span> <span class="n">check_password_hash</span>
<span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">Users</span><span class="p">,</span> <span class="n">Polls</span><span class="p">,</span> <span class="n">Topics</span>

<span class="n">votr</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="c"># load config from the config file we created earlier</span>
<span class="n">votr</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s">'config'</span><span class="p">)</span>

<span class="c"># create the database</span>
<span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">votr</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">votr</span><span class="p">)</span>

<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">(</span><span class="n">votr</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>


<span class="nd">@votr.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'index.html'</span><span class="p">)</span>


<span class="nd">@votr.route</span><span class="p">(</span><span class="s">'/signup'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">signup</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>

        <span class="c"># get the user details from the form</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'email'</span><span class="p">]</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'username'</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'password'</span><span class="p">]</span>

        <span class="c"># hash the password</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">Users</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">flash</span><span class="p">(</span><span class="s">'Thanks for signing up please login'</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'home'</span><span class="p">))</span>

    <span class="c"># it's a GET request, just render the template</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'signup.html'</span><span class="p">)</span>


<span class="nd">@votr.route</span><span class="p">(</span><span class="s">'/login'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="c"># we don't need to check the request type as flask will raise a bad request</span>
    <span class="c"># error if a request aside from POST is made to this url</span>

    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'username'</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'password'</span><span class="p">]</span>

    <span class="c"># search the database for the User</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">Users</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="n">password_hash</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>

        <span class="k">if</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="n">password_hash</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
            <span class="c"># The hash matches the password in the database log the user in</span>
            <span class="n">session</span><span class="p">[</span><span class="s">'user'</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>

            <span class="n">flash</span><span class="p">(</span><span class="s">'Login was succesfull'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># user wasn't found in the database</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">'Username or password is incorrect please try again'</span><span class="p">,</span> <span class="s">'error'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'home'</span><span class="p">))</span>


<span class="nd">@votr.route</span><span class="p">(</span><span class="s">'/logout'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="k">if</span> <span class="s">'user'</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'user'</span><span class="p">)</span>

        <span class="n">flash</span><span class="p">(</span><span class="s">'We hope to see you again!'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'home'</span><span class="p">))</span>


<span class="nd">@votr.route</span><span class="p">(</span><span class="s">'/polls'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">polls</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'polls.html'</span><span class="p">)</span>


<span class="nd">@votr.route</span><span class="p">(</span><span class="s">'/api/polls'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="c"># retrieves/adds polls from/to the database</span>
<span class="k">def</span> <span class="nf">api_polls</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="c"># get the poll and save it in the database</span>
        <span class="n">poll</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

        <span class="k">return</span> <span class="s">"The title of the poll is {} and the options are {} and {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">poll</span><span class="p">[</span><span class="s">'title'</span><span class="p">],</span> <span class="o">*</span><span class="n">poll</span><span class="p">[</span><span class="s">'options'</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c"># return dict representation of our API</span>
        <span class="n">polls</span> <span class="o">=</span> <span class="n">Topics</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Polls</span><span class="p">)</span><span class="o">.</span><span class="nb">all</span><span class="p">()</span>
        <span class="n">all_polls</span> <span class="o">=</span> <span class="p">[</span><span class="n">poll</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span> <span class="k">for</span> <span class="n">poll</span> <span class="ow">in</span> <span class="n">polls</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">all_polls</span><span class="p">)</span></code></pre></figure>

<p>Notice how we don’t have the <code class="highlighter-rouge">if __name__ == "__main__"</code> condition again? we don’t need this again because flask migrate has exposed some additional commands for database migrations to us and we need a way to run those commands.</p>

<p>So we’re going to change the way our flask app is run from now on.</p>

<p>from your terminal type in the following</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">export </span><span class="nv">FLASK_APP</span><span class="o">=</span>votr.py
<span class="nb">export </span><span class="nv">FLASK_DEBUG</span><span class="o">=</span>1   </code></pre></figure>

<p>This set’s the flask app to votr and then turns on debug mode</p>

<p>To prevent yourself from typing this anytime you want to work on votr (possibly after a reboot) just add those two lines
to your activate script for your virtualenv. located in the bin directory in your virtualenv’s root folder.</p>

<p>Anytime you run <code class="highlighter-rouge">source/bin/activate</code> the correct app and the debug mode would be set.</p>

<p>To run the initial migration, run this from the terminal</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">flask db init</code></pre></figure>

<p>You’ll be instructed to edit the alembic file in the migrations folder. (You don’t really need to for a simple database like this)</p>

<p>Then generate an initial migration with</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">flask db migrate</code></pre></figure>

<p>After doing this you can now make the required change to the <code class="highlighter-rouge">Topics</code> model</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Model for poll topics</span>
<span class="k">class</span> <span class="nc">Topics</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">500</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">)</span> <span class="c"># to mark poll as open or closed should be under title not polls</span>

    <span class="c"># user friendly way to display the object</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>

    <span class="c"># returns dictionary that can easily be jsonified</span>
    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
                <span class="s">'title'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                <span class="s">'options'</span><span class="p">:</span>
                    <span class="p">[{</span><span class="s">'name'</span><span class="p">:</span> <span class="n">option</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">'vote_count'</span><span class="p">:</span> <span class="n">option</span><span class="o">.</span><span class="n">vote_count</span><span class="p">}</span>
                        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="nb">all</span><span class="p">()]</span>
            <span class="p">}</span></code></pre></figure>

<p>Now run</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">flask db migrate
flask db upgrade</code></pre></figure>

<p>You should oops!</p>

<p><code class="highlighter-rouge">sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) near "DROP": syntax error [SQL: 'ALTER TABLE polls DROP COLUMN status']</code></p>

<p>Don’t worry this problem is not from you it’s because SQLite doesn’t support alter statements fully, <a href="https://www.sqlite.org/lang_altertable.html">docs</a> Gladly there is a workaroud in alembic &gt; 0.7 (alembic is what actually handles the database migration, flask migrate is just a library that provides better integration with flask) that simulates this behaviour by:</p>

<ol>
  <li>
    <p>Renaming the table</p>
  </li>
  <li>
    <p>Creating a new table with the old name of the previous table with the new column</p>
  </li>
  <li>
    <p>Copying data over from the old table to the new one</p>
  </li>
  <li>
    <p>And finally dropping the old table</p>
  </li>
</ol>

<p>This procedure is called a <em>Batch Migration</em> and it’s not perfect in alembic and most times you’ll need to edit the migrations file yourself to make it work. but don’t panic I’ll hold your hand as we go.</p>

<p>Edit votr.py and include the new parameter render_as_batch</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">(</span><span class="n">votr</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">render_as_batch</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></code></pre></figure>

<p>That should prevent this issue from happening in subsequent migrations, but we didn’t apply this fix before the initial migration, so now we have to manually edit the migration file and fix that.</p>

<p>Go the the <code class="highlighter-rouge">migrations/versions</code> folder and you should see a python file with a random number as the name (mine was <code class="highlighter-rouge">347f4ec5eb5e_.py</code>, yours would be different), this is the migration that alembic automatically generated for us. If you’re familiar with alembic, you could easily write one yourself too.</p>

<p>Edit the upgrade function in the file to look like this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">upgrade</span><span class="p">():</span>
    <span class="c">### commands auto generated by Alembic - please adjust! ###</span>
    <span class="k">with</span> <span class="n">op</span><span class="o">.</span><span class="n">batch_alter_table</span><span class="p">(</span><span class="s">"polls"</span><span class="p">)</span> <span class="k">as</span> <span class="n">batch_op</span><span class="p">:</span>
        <span class="n">batch_op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s">'status'</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s">'topics'</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">'status'</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
    <span class="c">### end Alembic commands ###</span></code></pre></figure>

<p>We aren’t going to touch the <code class="highlighter-rouge">downgrade</code> function because we have no plans of going back to the previous schema of our database before the migration</p>

<p>After doing all this you should be able to run <code class="highlighter-rouge">flask db upgrade</code> without any issues</p>

<p>Now lets fix our api by adding the status field, edit the <code class="highlighter-rouge">to_json</code> method in <code class="highlighter-rouge">votr.py</code></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># returns dictionary that can easily be jsonified</span>
<span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
            <span class="s">'title'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="s">'options'</span><span class="p">:</span>
                <span class="p">[{</span><span class="s">'name'</span><span class="p">:</span> <span class="n">option</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">'vote_count'</span><span class="p">:</span> <span class="n">option</span><span class="o">.</span><span class="n">vote_count</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="nb">all</span><span class="p">()],</span>
            <span class="s">'status'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span>
        <span class="p">}</span></code></pre></figure>

<p>In the next section we’re going to update the existing status for the polls we’ve already created</p>

<h3 id="flask-cli">Flask CLI</h3>
<p>Normally you’d start a python interactive shell by typing <code class="highlighter-rouge">python</code> in the terminal.</p>

<p>Flask has some commands that we can use to do that and more (<strong>Make sure you run it in the same directory where <code class="highlighter-rouge">votr.py</code> is located</strong>)</p>

<p>Now you can start an interactive python shell with:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">flask shell</code></pre></figure>

<p>This will start up an interactive Python shell like you’d expect but it also sets up the correct application context and some variables for you. You don’t need to import <code class="highlighter-rouge">votr</code> anymore it’s available to us as variable called <code class="highlighter-rouge">app</code></p>

<p>Let’s update the Topics and make them all open for voting</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">&gt;&gt;&gt; </span><span class="k">for </span>topic <span class="k">in </span>Topics.query.all<span class="o">()</span>:
...     topic.status <span class="o">=</span> 1
...
<span class="gp">&gt;&gt;&gt; </span>from votr import db
<span class="gp">&gt;&gt;&gt; </span>db.session.commit<span class="o">()</span></code></pre></figure>

<p>That’s it. All our existing polls are now open for voting</p>

<p>You can now run the application with</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>flask run</code></pre></figure>

<h3 id="testing-the-api">Testing the API</h3>
<p>To test our API we need to be able to make <code class="highlighter-rouge">requests</code> to it. Python already has an excellent module for this named the <code class="highlighter-rouge">requests</code> module. Install it from pip with</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">pip install requests</code></pre></figure>

<p>Open another Python shell, import the module and make a get request to the url the app’s listening on</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">&gt;&gt;&gt; </span>import requests
<span class="gp">&gt;&gt;&gt; </span>requests.get<span class="o">(</span><span class="s1">'http://localhost:5000/api/polls'</span><span class="o">)</span>
&lt;Response <span class="o">[</span>200]&gt;
<span class="gp">&gt;&gt;&gt; </span>requests.get<span class="o">(</span><span class="s1">'http://localhost:5000/api/polls'</span><span class="o">)</span>.text
<span class="s1">'[\n  {\n    "Which side is going to win the EPL this season": {\n      "options": [\n        "Arsenal", \n        "Spurs"\n      ], \n      "status": true\n    }\n  }, \n  {\n    "Whos better liverpool or city": {\n      "options": [\n        "Liverpool FC", \n        "Manchester city"\n      ], \n      "status": true\n    }\n  }\n]\n'</span>
<span class="gp">&gt;&gt;&gt; </span>requests.get<span class="o">(</span><span class="s1">'http://localhost:5000/api/polls'</span><span class="o">)</span>.json<span class="o">()</span>
<span class="o">[{</span><span class="s1">'Which side is going to win the EPL this season'</span>: <span class="o">{</span><span class="s1">'options'</span>: <span class="o">[</span><span class="s1">'Arsenal'</span>, <span class="s1">'Spurs'</span><span class="o">]</span>, <span class="s1">'status'</span>: True<span class="o">}}</span>, <span class="o">{</span><span class="s1">'Whos better liverpool or city'</span>: <span class="o">{</span><span class="s1">'options'</span>: <span class="o">[</span><span class="s1">'Liverpool FC'</span>, <span class="s1">'Manchester city'</span><span class="o">]</span>, <span class="s1">'status'</span>: True<span class="o">}}]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="o">(</span>requests.get<span class="o">(</span><span class="s1">'http://localhost:5000/api/polls'</span><span class="o">)</span>.json<span class="o">())</span>
&lt;class <span class="s1">'list'</span>&gt;</code></pre></figure>

<p>Nice we got what we we’re expecting from our API</p>

<p>The request module even has a nifty <code class="highlighter-rouge">json</code> method that converts the json response to a python representation which is a list containing two dictionaries.</p>

<p>Let’s make a POST request to add a new polls</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">'http://localhost:5000/api/polls'</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s">"title"</span><span class="p">:</span> <span class="s">"who's the fastest footballer"</span><span class="p">,</span><span class="s">"options"</span><span class="p">:</span> <span class="p">[]})</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="p">{</span><span class="s">'error'</span><span class="p">:</span> <span class="s">'value for options is empty'</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">'http://localhost:5000/api/polls'</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s">"title"</span><span class="p">:</span> <span class="s">""</span><span class="p">,</span><span class="s">"options"</span><span class="p">:</span> <span class="p">[</span><span class="s">"Gareth Bale"</span><span class="p">]})</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="p">{</span><span class="s">'error'</span><span class="p">:</span> <span class="s">'value for title is empty'</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">'http://localhost:5000/api/polls'</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s">"title"</span><span class="p">:</span> <span class="s">"who's the fastest footballer"</span><span class="p">,</span><span class="s">"options"</span><span class="p">:</span> <span class="p">[</span><span class="s">"Hector bellerin"</span><span class="p">,</span> <span class="s">"Gareth Bale"</span><span class="p">,</span> <span class="s">"Arjen robben"</span><span class="p">]})</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="p">{</span><span class="s">'message'</span><span class="p">:</span> <span class="s">'poll was created succesfully'</span><span class="p">}</span></code></pre></figure>

<p>It worked! we tested our validation by supplying invalid json</p>

<p>and then we finally gave it the right data and it succesfully created our poll. Let’s make a GET request to be sure the poll got saved in the database.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://localhost:5000/api/polls'</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="p">{</span><span class="s">'Polls'</span><span class="p">:</span> <span class="p">[{</span><span class="s">'options'</span><span class="p">:</span> <span class="p">[{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Arsenal'</span><span class="p">,</span> <span class="s">'vote_count'</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Spurs'</span><span class="p">,</span> <span class="s">'vote_count'</span><span class="p">:</span> <span class="mi">2</span><span class="p">}],</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'Which side is going to win the EPL this season'</span><span class="p">,</span> <span class="s">'status'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="p">{</span><span class="s">'options'</span><span class="p">:</span> <span class="p">[{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Liverpool FC'</span><span class="p">,</span> <span class="s">'vote_count'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Manchester city'</span><span class="p">,</span> <span class="s">'vote_count'</span><span class="p">:</span> <span class="mi">0</span><span class="p">}],</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">'Whos better liverpool or city'</span><span class="p">,</span> <span class="s">'status'</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span> <span class="p">{</span><span class="s">'options'</span><span class="p">:</span> <span class="p">[{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Hector bellerin'</span><span class="p">,</span> <span class="s">'vote_count'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Gareth Bale'</span><span class="p">,</span> <span class="s">'vote_count'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Arjen robben'</span><span class="p">,</span> <span class="s">'vote_count'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Hector bellerin'</span><span class="p">,</span> <span class="s">'vote_count'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Gareth Bale'</span><span class="p">,</span> <span class="s">'vote_count'</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Arjen robben'</span><span class="p">,</span> <span class="s">'vote_count'</span><span class="p">:</span> <span class="mi">0</span><span class="p">}],</span> <span class="s">'title'</span><span class="p">:</span> <span class="s">"who's the fastest footballer"</span><span class="p">,</span> <span class="s">'status'</span><span class="p">:</span> <span class="bp">True</span><span class="p">}]}</span>
<span class="o">&gt;&gt;&gt;</span></code></pre></figure>

<p>Congratulations! you’ve just built a fully functional API, that accepts JSON and also sends JSON data back when it’s queried</p>

<p>You’ve now provided a universal means for any client to that talks to your application…The client could be a mobile app, or even a Desktop app or another website!</p>

<h3 id="another-migration">Another Migration</h3>
<p>Now we want to make sure duplicate options don’t get stored in our database, to do that we’re going to make the <code class="highlighter-rouge">name</code> field in the <code class="highlighter-rouge">Options</code> table column unique. Change the declaration to this</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Model for poll options</span>
<span class="k">class</span> <span class="nc">Options</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></code></pre></figure>

<p>Now run:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>flask db migrate
<span class="gp">$ </span>flask db upgrade</code></pre></figure>

<p>Edit the new migrations file and change the <code class="highlighter-rouge">upgrade</code> method to</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">upgrade</span><span class="p">():</span>
    <span class="c">### commands auto generated by Alembic - please adjust! ###</span>
    <span class="k">with</span> <span class="n">op</span><span class="o">.</span><span class="n">batch_alter_table</span><span class="p">(</span><span class="s">'options'</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">batch_op</span><span class="p">:</span>
        <span class="n">batch_op</span><span class="o">.</span><span class="n">create_unique_constraint</span><span class="p">(</span><span class="s">'unique_user_name'</span><span class="p">,</span> <span class="p">[</span><span class="s">'name'</span><span class="p">])</span>

    <span class="c">### end Alembic commands ###</span></code></pre></figure>

<p>Don’t get it mistaken alembic isn’t as painful as this, we don’t have to edit the migrations file for every migration we do (<em>All these issues are as a result of us using SQLite and batch migrations</em>), if you use a more robust database like MYSQL or PostgreSQL you won’t come across this issue.</p>

<p>But it’s advised to always inspect the migration file before you do any migration because sometimes alembic won’t detect all the changes to you made to your model.</p>

<h3 id="link-existing-options">Link existing options</h3>
<p>We’ve finally set a unique constraint on our <code class="highlighter-rouge">Options</code> table so duplicate entries won’t be allowed.</p>

<p>Resend the previous poll we just created</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">'http://localhost:5000/api/polls'</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s">"title"</span><span class="p">:</span> <span class="s">"who's the fastest footballer"</span><span class="p">,</span><span class="s">"options"</span><span class="p">:</span> <span class="p">[</span><span class="s">"Hector bellerin"</span><span class="p">,</span> <span class="s">"Gareth Bale"</span><span class="p">,</span> <span class="s">"Arjen robben"</span><span class="p">]})</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></code></pre></figure>

<p>You should get a `JSONDecodeError, because we didn’t return any valid json back to the user, rather SQLAlchemy raised an exception. switch back to the flask terminal and you should see this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span> <span class="p">(</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">)</span> <span class="n">UNIQUE</span> <span class="n">constraint</span> <span class="n">failed</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">name</span> <span class="p">[</span><span class="n">SQL</span><span class="p">:</span> <span class="s">'INSERT INTO options (date_created, date_modified, name) VALUES (CURRENT_TIMESTAMP, CURRENT_TIMESTAMP, ?)'</span><span class="p">]</span> <span class="p">[</span><span class="n">parameters</span><span class="p">:</span> <span class="p">(</span><span class="s">'Hector bellerin'</span><span class="p">,)]</span></code></pre></figure>

<p>This means our unique constraint worked!</p>

<p>But now we need a way to link existing records to new polls. For example “Gareth bale” is a valid option for The “Fastest player in the world” and “The best footballer in the world” (hopefull when Messi and Cristiano Ronaldo retire)</p>

<p>So if an option exists in the database instead of failing with an <code class="highlighter-rouge">IntegrityError</code> we can link the old option with a new poll</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">title</span> <span class="o">=</span> <span class="n">poll</span><span class="p">[</span><span class="s">'title'</span><span class="p">]</span>

        <span class="n">options_query</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">option</span> <span class="p">:</span> <span class="n">Options</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">Options</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s">'</span><span class="si">%</span><span class="s">{}</span><span class="si">%</span><span class="s">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">option</span><span class="p">)))</span>

        <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="n">Polls</span><span class="p">(</span><span class="n">option</span><span class="o">=</span><span class="n">Options</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">option</span><span class="p">))</span>
                      <span class="k">if</span> <span class="n">options_query</span><span class="p">(</span><span class="n">option</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
                      <span class="k">else</span> <span class="n">Polls</span><span class="p">(</span><span class="n">option</span><span class="o">=</span><span class="n">options_query</span><span class="p">(</span><span class="n">option</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">())</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">poll</span><span class="p">[</span><span class="s">'options'</span><span class="p">]</span>
                  <span class="p">]</span>

        <span class="n">new_topic</span> <span class="o">=</span> <span class="n">Topics</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_topic</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></code></pre></figure>

<p>Pay close attention here</p>

<p>Make another post request and it should tell us the Poll was inserted successfully, even though “Gareth Bale” was part of the options</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">'http://localhost:5000/api/polls'</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s">"title"</span><span class="p">:</span> <span class="s">"who's the best footballer on the planet"</span><span class="p">,</span><span class="s">"options"</span><span class="p">:</span> <span class="p">[</span><span class="s">"Lionel Messi"</span><span class="p">,</span> <span class="s">"Gareth Bale"</span><span class="p">,</span> <span class="s">"Cristiano Ronaldo"</span><span class="p">,</span> <span class="s">"Alexis sanchez"</span><span class="p">]})</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></code></pre></figure>

<p>and we should get a json string telling us that it was created successfully</p>

<p>Lastly we need to build a new API endpoint that returns a list of all the options we have in our database, so as our users are trying to create a poll. They can see the list of all the options in our database in a drop down</p>

<p>Add a new endpoint to the <code class="highlighter-rouge">votr.py</code></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@votr.route</span><span class="p">(</span><span class="s">'/api/polls/options'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">api_polls_options</span><span class="p">():</span>

    <span class="n">all_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">option</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">Options</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="nb">all</span><span class="p">()]</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">all_options</span><span class="p">)</span></code></pre></figure>

<p>Now add the <code class="highlighter-rouge">to_json</code> method on the Options model</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Model for poll options</span>
<span class="k">class</span> <span class="nc">Options</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
                <span class="s">'id'</span><span class="p">:</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span> <span class="c"># Generates a random uuid</span>
                <span class="s">'name'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="p">}</span></code></pre></figure>

<p>instead of sending the id (database id) of the record back to the user we sent back a uuid (Universally unique identification) instead. We did this for security reasons. You should expose as little information about the inner workings of your application as possible (though this makes it harder to accomplish some tasks) so that hackers cannot easily guess out the structure of your application.</p>

<p>Let’s test it</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://localhost:5000/api/polls/options'</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="p">[{</span><span class="s">'id'</span><span class="p">:</span> <span class="s">'5f4ceb02-bafa-4910-a156-9c3972a1d123'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">:</span> <span class="s">'Arsenal'</span><span class="p">},</span> <span class="p">{</span><span class="s">'id'</span><span class="p">:</span> <span class="s">'dba2948f-f9a1-49d9-ac70-6102b90ffa52'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">:</span> <span class="s">'Spurs'</span><span class="p">},</span> <span class="p">{</span><span class="s">'id'</span><span class="p">:</span> <span class="s">'8dadd3d6-f723-4af9-a6b6-503ef85f41ca'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">:</span> <span class="s">'Liverpool FC'</span><span class="p">},</span> <span class="p">{</span><span class="s">'id'</span><span class="p">:</span> <span class="s">'a314955c-3453-4491-a14a-193bdf80db79'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">:</span> <span class="s">'Manchester city'</span><span class="p">},</span> <span class="p">{</span><span class="s">'id'</span><span class="p">:</span> <span class="s">'867f16a2-52dc-4a77-84d1-9f8e52a7728b'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">:</span> <span class="s">'Hector bellerin'</span><span class="p">},</span> <span class="p">{</span><span class="s">'id'</span><span class="p">:</span> <span class="s">'2ec9e28a-bb66-49ab-9cdf-da5d9f10c076'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">:</span> <span class="s">'Gareth Bale'</span><span class="p">},</span> <span class="p">{</span><span class="s">'id'</span><span class="p">:</span> <span class="s">'4d0a25a5-e2f1-4505-87bc-aeca23db6597'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">:</span> <span class="s">'Arjen robben'</span><span class="p">},</span> <span class="p">{</span><span class="s">'id'</span><span class="p">:</span> <span class="s">'0b0e85f8-ac58-4c64-9c4d-de890cb92f41'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">:</span> <span class="s">'Lionel Messi'</span><span class="p">},</span> <span class="p">{</span><span class="s">'id'</span><span class="p">:</span> <span class="s">'9bc0acae-fa15-42db-8d28-52a27757d6c0'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">:</span> <span class="s">'Cristiano Ronaldo'</span><span class="p">},</span> <span class="p">{</span><span class="s">'id'</span><span class="p">:</span> <span class="s">'40b6b016-53c2-421d-8bfa-6b6ee9d14c4b'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">:</span> <span class="s">'Alexis sanchez'</span><span class="p">}]</span>
<span class="o">&gt;&gt;&gt;</span></code></pre></figure>

<p>What’s left is to make sure our users can vote</p>

<p>To achieve this we’ll make another api endpoint and this time send a <code class="highlighter-rouge">PATCH</code> request. a PATCH request unlike post is used to update existing information</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@votr.route</span><span class="p">(</span><span class="s">'/api/poll/vote'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'PATCH'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">api_poll_vote</span><span class="p">():</span>

    <span class="n">poll</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>

    <span class="n">poll_title</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="p">(</span><span class="n">poll</span><span class="p">[</span><span class="s">'poll_title'</span><span class="p">],</span> <span class="n">poll</span><span class="p">[</span><span class="s">'option'</span><span class="p">])</span>

    <span class="n">join_tables</span> <span class="o">=</span> <span class="n">Polls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Topics</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Options</span><span class="p">)</span>
    <span class="c"># filter options</span>
    <span class="n">option</span> <span class="o">=</span> <span class="n">join_tables</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">Topics</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">poll_title</span><span class="p">))</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">Options</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">option</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="c"># increment vote_count by 1 if the option was found</span>
    <span class="k">if</span> <span class="n">option</span><span class="p">:</span>
        <span class="n">option</span><span class="o">.</span><span class="n">vote_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'message'</span><span class="p">:</span> <span class="s">'Thank you for voting'</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">'message'</span><span class="p">:</span> <span class="s">'option or poll was not found please try again'</span><span class="p">})</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s">'http://localhost:5000/api/poll/vote'</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s">"poll_title"</span><span class="p">:</span> <span class="s">"who's the fastest footballer"</span><span class="p">,</span> <span class="s">"option"</span><span class="p">:</span> <span class="s">"Hector bellerin"</span><span class="p">})</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="p">{</span><span class="s">'message'</span><span class="p">:</span> <span class="s">'Thank you for voting'</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">requests</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s">'http://localhost:5000/api/poll/vote'</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s">"poll_title"</span><span class="p">:</span> <span class="s">"who's the fastest footballer"</span><span class="p">,</span> <span class="s">"option"</span><span class="p">:</span> <span class="s">"Mertesacker"</span><span class="p">})</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="p">{</span><span class="s">'message'</span><span class="p">:</span> <span class="s">'option or poll was not found please try again'</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span></code></pre></figure>


            </div>

        <hr>

        <aside id="comments" class="disqus">
          <div class="container">
            <h3><i class="fa fa-comments-o"></i> Comments</h3>
            <div id="disqus_thread"></div>
            <script>



              var disqus_config = function() {
                this.page.url = 'https://danidee10.github.io/2016/10/05/flask-by-example-5.html'; //shouldn't hardoce this
                this.page.identifier = 'Flask by example 5 (Building a simple REST API)';
              };
              (function() {
                var d = document,
                s = d.createElement('script');
                s.src = '//osaetin-daniel.disqus.com/embed.js';
                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
              })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
          </div>
        </aside>

          </div>

        </article>

      </div>

      <footer class="site-footer">
  <div class="container">
    <ul class="social">
      <li><a href="http://github.com/danidee10" target="_blank"><i class="fa fa-github"></i></a></li>
      <li><a href="http://twitter.com/osaetindaniel" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
      <li><a href="https://www.facebook.com/osaetin.daniel" target="_blank"><i class="fa fa-facebook"></i></a></li>
      <li><a href="https://www.linkedin.com/in/osaetin-daniel-87604098" target="_blank"><i class="fa fa-linkedin"></i></a></li>
    </ul>
    <p class="txt-medium-gray">
      <small>&copy;2016 All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥</small>
    </p>
  </div>
</footer>


<a href="https://github.com/danidee10" target="_blank" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#337ab7; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
<script>
$(document).ready(function() {
  $('.sliding-panel-button,.sliding-panel-fade-screen,.sliding-panel-close').on('click touchstart',function (e) {
    $('.sliding-panel-content,.sliding-panel-fade-screen').toggleClass('is-visible');
    e.preventDefault();
  });
});
</script>

    </main>
  </body>
</html>
